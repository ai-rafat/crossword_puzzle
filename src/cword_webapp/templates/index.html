<!-- The main (and only) page for the Crossword Puzzle game. This file contains the html that lays
out the crossword grid, as well as the html to display the positions and clues of the words, and CSS.

This file is viewed through a flask server and is interpreted by Jinja2 to help generate dynamic 
content, as each crossword created by this program is unique (unless you get lucky). 
-->

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ _('Crossword Puzzle - Game') }}</title>
    <script src="{{ url_for('static', filename='interaction.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css')}}">
    <style>
        :root { 
            --dimensions: {{ dimensions }};
            --cell_font_size: calc(95vmin / calc(var(--dimensions) * 1.7));
            --num_label_font_size: calc(var(--cell_font_size) / 1.79);
            --grid_size: calc(95vmin / var(--dimensions));
            --main_colour: {{ colour_palette["MAIN"] }};
            --sub_colour: {{ colour_palette["SUB"] }};
            --text_colour: {{ colour_palette["TEXT"] }};
            --button_colour: {{ colour_palette["BUTTON"] }};
            --button_hover_colour: {{ colour_palette["BUTTON_HOVER"] }};
            --button_text_colour: {{ colour_palette["BUTTON_TEXT_COLOUR"] }};
            --correct_colour: {{ colour_palette["CORRECT"] }};
            --wrong_colour: {{ colour_palette["WRONG"] }};
            --text_disabled_colour: {{ colour_palette["TEXT_DISABLED"] }};
        }    
    </style>

    <script type="text/javascript">
        let completionPopupToggled = false;
        let onloadPopupToggled = false;
        let currentDropdown = null;
        let toggleCheckBox = document.getElementById("tcb");

        document.addEventListener('DOMContentLoaded', () => {
            let toggleCheckBox = document.getElementById("tcb");

            toggleCheckBox.addEventListener("change", () => {
                if (toggleCheckBox.checked) {
                    document.cookie = "tcbChecked=true; expires=Fri, 31 Dec 9999 23:59:59 GMT; SameSite=Lax";
                } else {
                    document.cookie = "tcbChecked=; expires=Fri, 31 Dec 9999 23:59:59 GMT; SameSite=Lax";
                }
            });
        });

        document.addEventListener("click", event => { // Close dropdowns if clicking outside of the dropdown area
            if (!event.target.closest('.special_button, .dropdown, .dropdown_button')) { 
                hideDropdowns();
            }
        });

        document.addEventListener("focusout", event => { // Hide dropdowns based on specific conditions
            /* The following condition evaluates to true if:
                1. Focusing into something that is not a "dropdown_button" OR
                2. Focusing out of something that is a "dropdown_button" AND
                    - You are focusing into something that is a "special_button" AND
                    - You are focusing into something that has an id that does not match the start of the currentDropdown
                3. You are focusing out of a "special_button" into something that is either another special button or something that isn't a "dropdown_button"
            */
            if ((!event.relatedTarget?.classList.contains("dropdown_button"))
                || (event.target?.classList.contains("dropdown_button") 
                    && event.relatedTarget?.classList.contains("special_button") 
                    && !event.relatedTarget?.id.startsWith(currentDropdown?.substring(0, currentDropdown?.indexOf('_'))))
                || event.target.id?.endsWith("button") 
                    && (event.relatedTarget?.id?.endsWith("button") || !event.relatedTarget?.classList?.contains("dropdown_button"))) {
                hideDropdowns();
            }
        });


        const hideDropdowns = () => {
            document.querySelectorAll(".dropdown").forEach(element => element.classList.remove("show_dropdown"));
            currentDropdown = null;
        }

        function toggleCompletionPopup() {
            completionPopupToggled = !completionPopupToggled;
            document.getElementById("blur").classList.toggle("active");
            document.getElementById("completion_popup").classList.toggle("active");
            if (completionPopupToggled) { /* Focus the close button */
                sleep(501).then(() => document.getElementsByClassName("close_button")[0].focus({ focusVisible: true })); }
        }

        function onDropdownClick(id) {
            /* Opens the dropdown a user clicks on or closes it if they already have it open. */
            let dropdown = document.getElementById(id);
            if (id === currentDropdown) {
                dropdown.classList.remove("show_dropdown");
                currentDropdown = null;
                return;
            }
            hideDropdowns();
            dropdown.classList.add("show_dropdown");
            currentDropdown = id;
        }

        function closeOnloadPopup() {
            onloadPopupToggled = false;
            document.getElementById("blur").classList.toggle("active");
            document.getElementById("onload_popup").classList.toggle("active");
        }

        function getCookie(cName) {
            let name = cName + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let cookies = decodedCookie.split(";");
            for (let i = 0; i < cookies.length; i++) { // Search for the cookie
                let cookie = cookies[i];
                if (cookie.indexOf(name) == 0) {
                    return cookie.substring(name.length, cookie.length);
                }
            }

            return "";
        }
    </script>
</head>

<body 
    data-grid="{{ grid }}" 
    data-dimensions="{{ dimensions }}" 
    data-empty="{{ empty }}"   
    data-colour_palette="{{ json_colour_palette }}"
    data-intersections="{{ intersections }}"
    data-js_err_msgs="{{ js_err_msgs }}">

    <div class="container" id="blur">
        <div class="grid">
        {% for row in range(dimensions) %} 
        {% for column in range(dimensions) %}
            {% if grid[row][column] != empty %} {# There is a word in this cell #}
                <div 
                    onclick="onCellClick(this)" 
                    class="non_empty_cell" 
                    data-row="{{ row }}" 
                    data-column="{{ column }}" 
                    data-value="{{ grid[row][column] }}">

                    {% if (row, column) in starting_word_positions %} {# Start of a word #}
                        <div
                            class="num_label" 
                            data-num_label="{{ starting_word_matrix[row][column] }}">
                            {{ starting_word_matrix[row][column] }}
                        </div>
                    {% endif %}
                </div>
            {% else %} {# This cell will have no characters #}
                <div 
                    class="empty_cell" 
                    data-row="{{ row }}" 
                    data-column="{{ column }}" 
                    data-value="None">
                </div>
            {% endif %} 
        {% endfor %}  
        {% endfor %} 
        </div>

        <div class="definitions">
            {% set ns = namespace(tab_index_counter = 12) %}
            <div class="definitions_a"> {# Column one for across definitions #}
                <ul>
                    <h3 class="def_heading">{{ _('Across') }}</h3>
                    {% for dict_ in definitions_a %}
                    {% for num_label, definition in dict_.items()%}
                        <li 
                            class="def"
                            tabindex="{{ ns.tab_index_counter }}"
                            data-num="{{ num_label }}" 
                            data-word="{{ definition[0].upper() }}"
                            onclick="onDefinitionsListItemClick('{{ num_label }}', '{{ directions[0] }}')"><b>{{ num_label }}</b>  {{ definition[1] }}</li>
                        {% set ns.tab_index_counter = ns.tab_index_counter + 1 %}
                    {% endfor %}
                    {% endfor %}
                </ul>
            </div>  

            <div class="definitions_d"> {# Column two for downward definitions #}
                <ul>
                    <h3 class="def_heading">{{ _('Down') }}</h3>
                    {% for dict_ in definitions_d %}
                    {% for num_label, definition in dict_.items()%}
                        <li 
                            class="def"
                            tabindex="{{ ns.tab_index_counter }}"
                            data-num="{{ num_label }}" 
                            data-word="{{ definition[0].upper() }}"
                            onclick="onDefinitionsListItemClick('{{ num_label }}', '{{ directions[1] }}')"><b>{{ num_label }}</b>  {{ definition[1] }}</li>
                        {% set ns.tab_index_counter = ns.tab_index_counter + 1 %}
                    {% endfor %}
                    {% endfor %}
                </ul>
            </div>

            {# Reveal, check, and clear dropdowns and their respective buttons #}
            <div class="top_buttons_container">
                <button tabindex="1" class="special_button" id="reveal_button" onclick="onDropdownClick('reveal_dropdown')">{{ _('Reveal') }}</button>
                <div class="dropdown" id="reveal_dropdown">
                    <button class="dropdown_button" tabindex="2" onclick="doSpecialButtonAction('cell', 'reveal')">{{ _('Cell') }}</button>
                    <button class="dropdown_button" tabindex="3" onclick="doSpecialButtonAction('word', 'reveal')">{{ _('Word') }}<span class="keybind_span"> [⇧+↵]</span></button>
                    <button class="dropdown_button" tabindex="4" onclick="doSpecialButtonAction('grid', 'reveal')">{{ _('Grid') }}</button>
                </div>

                <button tabindex="5" class="special_button" id="check_button" onclick="onDropdownClick('check_dropdown')">{{ _('Check') }}</button>
                <div class="dropdown" id="check_dropdown">
                    <button class="dropdown_button" tabindex="6" onclick="doSpecialButtonAction('cell', 'check')">{{ _('Cell') }}</button>
                    <button class="dropdown_button" tabindex="7" onclick="doSpecialButtonAction('word', 'check')">{{ _('Word') }}<span class="keybind_span"> [↵]</span></button>
                    <button class="dropdown_button" tabindex="8" onclick="doSpecialButtonAction('grid', 'check')">{{ _('Grid') }}</button>
                </div>

                <button tabindex="9" class="special_button" id="clear_button" onclick="onDropdownClick('clear_dropdown')">{{ _('Clear') }}</button>
                <div class="dropdown" id="clear_dropdown">
                    <button class="dropdown_button" tabindex="10" onclick="doSpecialButtonAction('word', 'clear')">{{ _('Word') }}<span class="keybind_span"> [⇧+⌫]</span></button>
                    <button class="dropdown_button" tabindex="11" onclick="doSpecialButtonAction('grid', 'clear')">{{ _('Grid') }}</button>
                </div>
            </div>

            <label class="toggle">
                <input class="toggle_checkbox" id="tcb" type="checkbox">
                <div class="toggle_switch"></div>
                <span class="toggle_label">{{ _('Smart Skip') }}</span>
            </label>
        </div>
    </div>

    {# Popup that displays on loading the web app - displays the crossword name, category and word count #}
    <div id="onload_popup" class="popup">
        <h2>{{ _('Crossword Puzzle - Game') }}</h2>
        <p>{{ _('You are viewing') }} {{ name }} ({{ difficulty }}) {{ _('from') }} {{ _(category.title()) }}</p>
        {% if failed_insertions > 0 %}
            <p>{{ failed_insertions }} {{ _('word(s) could not be inserted, sorry.') }}</p>
            <p>{{ _('Word count (adjusted)') }}: {{ word_count - failed_insertions }}</p>
        {% else %}
            <p>{{ _('Word count') }}: {{ word_count }}</p>
        {% endif %}
        <button id="close_popup_button" class="continue_button" onclick="closeOnloadPopup()">{{ _('Continue') }}</button>
    </div>

    {# Popup that displays on completion of the crossword #}
    <div id="completion_popup" class="popup">
        <h2>{{ _('You completed the crossword!') }}</h2>
        <button id="close_popup_button" class="close_button" onclick="toggleCompletionPopup()">{{ _('Close') }}</button>
    </div>
</body>
</html> 